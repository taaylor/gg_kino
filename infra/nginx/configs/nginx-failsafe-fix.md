# Исправление проблемы с падением nginx при недоступности сервисов

## Проблема
Nginx падал с ошибкой `host not found in upstream` при недоступности сервисов во время запуска, поскольку пытался разрешить DNS-имена upstream серверов на этапе инициализации.

## Решение
Заменили статичные upstream блоки на динамическое разрешение имён с использованием переменных.

### Ключевые изменения:

1. **Добавлен resolver**: `resolver 127.0.0.11 valid=10s ipv6=off;`
   - 127.0.0.11 - встроенный DNS-сервер Docker
   - valid=10s - кэширование DNS записей на 10 секунд
   - ipv6=off - отключение IPv6 для стабильности

2. **Убраны upstream блоки**: Заменены на переменные в location'ах
   ```nginx
   # Вместо upstream блока:
   set $backend "service-name:8000";
   proxy_pass http://$backend/path/;
   ```

3. **Добавлены таймауты**: Быстрая реакция на недоступность сервисов
   ```nginx
   proxy_connect_timeout 5s;
   proxy_send_timeout 10s;
   proxy_read_timeout 10s;
   ```

4. **Улучшена обработка ошибок**: Специфичные обработчики для каждого сервиса
   - Информативные JSON-ответы
   - Указание времени повтора (Retry-After: 30)
   - Логирование проблемного сервиса

5. **Добавлен health check**: `/health` endpoint для мониторинга nginx

### Преимущества нового подхода:

1. **Graceful degradation**: nginx запускается даже если сервисы недоступны
2. **Быстрые таймауты**: Пользователи получают ответ через 5-10 секунд вместо долгого ожидания
3. **Информативные ошибки**: JSON-ответы с указанием проблемного сервиса
4. **Мониторинг**: health check endpoint для проверки состояния nginx
5. **Простота**: Меньше конфигурации, проще в понимании и отладке

### Как это работает:

1. При запуске nginx не пытается разрешить DNS-имена сервисов
2. DNS-разрешение происходит только при первом запросе к сервису
3. Если сервис недоступен, nginx возвращает 503 с информативным сообщением
4. DNS записи кэшируются на 10 секунд для производительности

### Тестирование:

```bash
# Запуск nginx без других сервисов - должен запуститься успешно
docker-compose up nginx

# Проверка health check
curl localhost/health

# Проверка обработки недоступного сервиса
curl localhost/admin/
```

Результат: nginx теперь запускается независимо от доступности backend сервисов и корректно обрабатывает их недоступность во время работы.
